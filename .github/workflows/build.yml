name: Rust CLI Multi-Platform CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  release:
    types: [created]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # 测试阶段
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - run: cargo test --all-features

  # Windows 构建（多种目标）
  build-windows:
    needs: test
    runs-on: windows-latest
    strategy:
      matrix:
        target: 
          - x86_64-pc-windows-msvc
          - x86_64-pc-windows-gnu
          - i686-pc-windows-msvc
    outputs:
      windows_version: ${{ steps.get_version.outputs.version }}
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Get Version
      id: get_version
      run: |
        $version = (cargo metadata --format-version 1 | ConvertFrom-Json).packages[0].version
        echo "version=$version" >> $env:GITHUB_OUTPUT
    
    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        targets: ${{ matrix.target }}
    
    - name: Install GNU toolchain
      if: contains(matrix.target, 'gnu')
      run: |
        choco install mingw -y
        echo "C:\ProgramData\chocolatey\lib\mingw\tools\install\mingw64\bin" >> $env:GITHUB_PATH
    
    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: windows-${{ runner.os }}-${{ matrix.target }}-cargo-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Build Release
      run: cargo build --release --target ${{ matrix.target }}
    
    - name: Strip debug symbols
      run: |
        cd target/${{ matrix.target }}/release
        Get-ChildItem *.exe | ForEach-Object {
          strip $_.Name 2>$null || echo "Strip not available, continuing..."
        }
    
    - name: Create Windows package
      run: |
        $target = "${{ matrix.target }}"
        $version = "${{ steps.get_version.outputs.version }}"
        $exeName = (Get-ChildItem -Path "target/$target/release/*.exe" | Select-Object -First 1).Name
        $baseName = $exeName -replace '\.exe$', ''
        
        # 创建发布目录
        New-Item -ItemType Directory -Path "windows-package" -Force
        
        # 复制文件
        Copy-Item "target/$target/release/$exeName" "windows-package/"
        
        # 创建批处理脚本示例
        @"
@echo off
echo %cd%
$baseName.exe --help
pause
"@ | Out-File -FilePath "windows-package/run-example.bat" -Encoding ASCII
        
        # 创建压缩包
        $zipName = "$baseName-windows-$target-$version.zip"
        Compress-Archive -Path "windows-package/*" -DestinationPath $zipName
        
        echo "Created package: $zipName"
    
    - name: Upload Windows artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-${{ matrix.target }}-${{ steps.get_version.outputs.version }}
        path: |
          target/${{ matrix.target }}/release/*.exe
          *.zip
        retention-days: 14

  # CentOS 7 构建（使用 Docker 兼容旧 glibc）
  build-centos7:
    needs: test
    runs-on: ubuntu-latest
    outputs:
      centos_version: ${{ steps.get_version.outputs.version }}
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Get Version
      id: get_version
      run: |
        echo "version=$(cargo metadata --format-version 1 | jq -r '.packages[0].version')" >> $GITHUB_OUTPUT
    
    - name: Setup Rust for cross-compilation
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        targets: x86_64-unknown-linux-gnu
    
    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: centos-${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Build with Docker for CentOS 7 compatibility
      run: |
        # 方法1: 使用 musl 静态链接（更简单，但可能不兼容所有库）
        echo "Building with musl for maximum compatibility..."
        rustup target add x86_64-unknown-linux-musl
        cargo build --release --target x86_64-unknown-linux-musl
        
        # 方法2: 使用交叉编译工具链在 Docker 中构建
        echo "Building with cross toolchain..."
        docker run --rm -v "$(pwd)":/usr/src/myapp -w /usr/src/myapp \
          centos:7 bash -c "
            yum install -y gcc gcc-c++ openssl-devel && \
            curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y && \
            source $HOME/.cargo/env && \
            cargo build --release
          " || echo "Docker build may fail if network is restricted"
    
    - name: Alternative: Build using centos7 docker image
      if: false  # 设置为 true 如果需要此方法
      run: |
        # 创建 Dockerfile 用于构建
        cat > Dockerfile.centos7 << 'EOF'
        FROM centos:7
        
        # 安装基础工具
        RUN yum install -y epel-release && \
            yum install -y gcc gcc-c++ openssl-devel pkgconfig make cmake git which
        
        # 安装较新版本的 glibc 和工具链
        RUN yum install -y centos-release-scl && \
            yum install -y devtoolset-9 devtoolset-9-libatomic-devel
        
        # 安装 Rust
        RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
        
        WORKDIR /build
        EOF
        
        # 构建并运行
        docker build -f Dockerfile.centos7 -t rust-centos7-builder .
        docker run --rm -v "$(pwd)":/build rust-centos7-builder bash -c "
          source /opt/rh/devtoolset-9/enable && \
          source $HOME/.cargo/env && \
          cargo build --release
        "
    
    - name: Build using cross-rs (推荐方法)
      run: |
        # 安装 cross
        cargo install cross --git https://github.com/cross-rs/cross
        
        # 使用 centos7 兼容的镜像构建
        # 需要先配置 Cross.toml
        cat > Cross.toml << 'EOF'
        [target.x86_64-unknown-linux-gnu]
        image = "docker.io/library/centos:7"
        
        # 在容器内安装构建依赖
        pre-build = [
          "yum install -y gcc gcc-c++ openssl-devel",
        ]
        EOF
        
        # 使用 cross 构建
        cross build --release --target x86_64-unknown-linux-gnu || echo "Cross build failed, trying alternative..."
    
    - name: Build statically for CentOS 7 (最终方案)
      run: |
        # 创建最小化的静态构建（最兼容）
        cat > .cargo/config.toml << 'EOF'
        [target.x86_64-unknown-linux-gnu]
        linker = "x86_64-linux-gnu-gcc"
        rustflags = ["-C", "target-feature=+crt-static"]
        EOF
        
        # 安装交叉编译工具链
        sudo apt-get update
        sudo apt-get install -y gcc-x86-64-linux-gnu
        
        # 设置链接器
        export CARGO_TARGET_X86_64_UNKNOWN_LINUX_GNU_LINKER=x86_64-linux-gnu-gcc
        export CC_x86_64_unknown_linux_gnu=x86_64-linux-gnu-gcc
        export CXX_x86_64_unknown_linux_gnu=x86_64-linux-gnu-g++
        
        # 构建静态版本
        cargo build --release --target x86_64-unknown-linux-gnu
        
        # 检查兼容性
        echo "Checking glibc version..."
        objdump -T target/x86_64-unknown-linux-gnu/release/* | grep GLIBC_ | sort -u || true
        
        # 使用 patchelf 如果需要降低 glibc 要求
        if command -v patchelf &> /dev/null; then
          for binary in target/x86_64-unknown-linux-gnu/release/*; do
            if [ -f "$binary" ] && [ -x "$binary" ]; then
              echo "Checking $binary"
              strings "$binary" | grep "^GLIBC_" | sort -V | tail -1
            fi
          done
        fi
    
    - name: Create CentOS 7 package
      run: |
        version="${{ steps.get_version.outputs.version }}"
        
        # 查找构建的可执行文件
        for binary in target/x86_64-unknown-linux-musl/release/* \
                      target/x86_64-unknown-linux-gnu/release/* \
                      target/release/*; do
          if [ -f "$binary" ] && [ -x "$binary" ]; then
            echo "Found binary: $binary"
            cp "$binary" "my-cli-centos7"
            break
          fi
        done
        
        # 如果没找到，尝试从可能的路径复制
        if [ ! -f "my-cli-centos7" ]; then
          find target -type f -executable -name "*" ! -name "*.so" ! -name "*.dll" ! -name "*.dylib" | head -1 | xargs -I {} cp {} my-cli-centos7 || true
        fi
        
        # 创建发布包结构
        mkdir -p centos-package/usr/local/bin
        mkdir -p centos-package/etc/my-cli
        
        if [ -f "my-cli-centos7" ]; then
          # 设置权限
          chmod +x my-cli-centos7
          
          # 复制到包目录
          cp my-cli-centos7 centos-package/usr/local/bin/
          
          # 检查文件信息
          file my-cli-centos7
          ldd my-cli-centos7 2>/dev/null || echo "Static binary or ldd not available"
          
          # 创建 systemd 服务文件（如果适用）
          cat > centos-package/etc/systemd/system/my-cli.service << EOF
          [Unit]
          Description=My CLI Tool
          After=network.target
          
          [Service]
          Type=simple
          ExecStart=/usr/local/bin/my-cli-centos7
          Restart=on-failure
          User=root
          
          [Install]
          WantedBy=multi-user.target
          EOF
          
          # 创建安装脚本
          cat > centos-package/install.sh << 'EOF'
          #!/bin/bash
          set -e
          
          echo "Installing My CLI Tool..."
          
          # 复制二进制文件
          cp usr/local/bin/my-cli-centos7 /usr/local/bin/my-cli
          chmod +x /usr/local/bin/my-cli
          
          # 复制配置文件
          if [ -d etc/my-cli ]; then
            mkdir -p /etc/my-cli
            cp -r etc/my-cli/* /etc/my-cli/ 2>/dev/null || true
          fi
          
          # 安装 systemd 服务
          if [ -f etc/systemd/system/my-cli.service ]; then
            cp etc/systemd/system/my-cli.service /etc/systemd/system/
            systemctl daemon-reload
            echo "To enable service: systemctl enable my-cli"
          fi
          
          echo "Installation complete!"
          echo "Run: my-cli --help"
          EOF
          
          chmod +x centos-package/install.sh
          
          # 创建压缩包
          tar -czf my-cli-centos7-$version.tar.gz -C centos-package .
          
          # 创建 RPM spec 文件（可选）
          cat > my-cli.spec << EOF
          Name: my-cli
          Version: ${version//-/_}
          Release: 1%{?dist}
          Summary: My CLI Tool
          License: MIT
          URL: https://github.com/yourusername/yourrepo
          Source0: my-cli-centos7-%{version}.tar.gz
          
          %description
          My CLI Tool for CentOS 7
          
          %prep
          %setup -q
          
          %build
          # 构建已在外部完成
          
          %install
          mkdir -p %{buildroot}/usr/local/bin
          install -m 755 usr/local/bin/my-cli-centos7 %{buildroot}/usr/local/bin/my-cli
          
          %files
          /usr/local/bin/my-cli
          
          %changelog
          * $(date +"%a %b %d %Y") Your Name <email@example.com> - ${version//-/_}-1
          - Initial package
          EOF
        else
          echo "WARNING: No binary found for CentOS 7"
        fi
    
    - name: Upload CentOS 7 artifacts
      uses: actions/upload-artifact@v4
      with:
        name: centos7-${{ steps.get_version.outputs.version }}
        path: |
          my-cli-centos7*
          *.tar.gz
          target/x86_64-unknown-linux-gnu/release/*
          target/x86_64-unknown-linux-musl/release/*
        retention-days: 14

  # 发布阶段
  release:
    needs: [test, build-windows, build-centos7]
    if: github.event_name == 'release' && github.event.action == 'created'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
    
    - name: Prepare release assets
      run: |
        mkdir -p release-assets
        
        # 整理所有构建成果
        find artifacts -type f \( -name "*.exe" -o -name "*.zip" -o -name "*.tar.gz" -o -name "my-cli-centos7" \) | while read file; do
          cp "$file" release-assets/
        done
        
        # 创建校验和文件
        cd release-assets
        echo "# SHA256 Checksums" > CHECKSUMS.txt
        echo "Generated: $(date -u)" >> CHECKSUMS.txt
        echo "" >> CHECKSUMS.txt
        
        for file in *; do
          if [ -f "$file" ]; then
            sha256sum "$file" >> CHECKSUMS.txt
            echo "  $file" >> CHECKSUMS.txt
          fi
        done
        
        # 创建简单的安装说明
        cat > INSTALL.md << 'EOF'
        # Installation Guide
        
        ## Windows
        Download the .exe file and run from command prompt.
        
        ## CentOS 7
        ```bash
        # Download the binary
        chmod +x my-cli-centos7
        sudo cp my-cli-centos7 /usr/local/bin/my-cli
        
        # Or use the tarball
        tar -xzf my-cli-centos7-*.tar.gz
        cd centos-package
        sudo ./install.sh
        ```
        
        ## Verify
        ```bash
        # Check integrity
        sha256sum -c CHECKSUMS.txt 2>/dev/null | grep OK
        
        # Test
        my-cli --version
        ```
        EOF
        
        echo "Release assets prepared:"
        ls -la
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: release-assets/*
        name: Release v${{ needs.build-windows.outputs.windows_version || needs.build-centos7.outputs.centos_version }}
        body: |
          Multi-platform CLI release
          
          ### Downloads
          - Windows: .exe files for various targets
          - CentOS 7: Binary and tarball
          
          ### Installation
          See INSTALL.md for details
          
          ### SHA256 Checksums
          See CHECKSUMS.txt
        draft: false
        prerelease: false